<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hive AI Agent</title>
  <style>
    /* â”€â”€ ê¸°ë³¸ ë¦¬ì…‹ ë° ë³€ìˆ˜ â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --primary:      #4f6ef7;
      --primary-dark: #3a57e8;
      --bg:           #f0f2f7;
      --surface:      #ffffff;
      --border:       #e2e5ed;
      --text:         #1a1d2e;
      --text-muted:   #7a7f9a;
      --user-bubble:  #4f6ef7;
      --agent-bubble: #f0f2f7;
      --danger:       #e74c3c;
      --success:      #27ae60;
      --radius:       12px;
      --shadow:       0 4px 24px rgba(0,0,0,0.08);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
      background: var(--bg);
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
    }

    /* â”€â”€ ë¡œê·¸ì¸ í™”ë©´ â”€â”€ */
    #login-screen {
      width: 100%;
      max-width: 400px;
      padding: 16px;
    }

    .login-card {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 40px 36px;
    }

    .login-logo {
      text-align: center;
      margin-bottom: 28px;
    }

    .login-logo h1 {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      margin-top: 8px;
    }

    .login-logo p {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group input {
      width: 100%;
      padding: 11px 14px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      font-size: 15px;
      color: var(--text);
      background: var(--surface);
      outline: none;
      transition: border-color 0.2s;
    }

    .form-group input:focus {
      border-color: var(--primary);
    }

    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, opacity 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
      margin-top: 8px;
    }

    .btn-primary:hover  { background: var(--primary-dark); }
    .btn-primary:active { opacity: 0.85; }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #login-error {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 8px;
      background: #fdecea;
      color: var(--danger);
      font-size: 13px;
      display: none;
    }

    /* â”€â”€ ì±„íŒ… í™”ë©´ â”€â”€ */
    #chat-screen {
      display: none;
      width: 100%;
      max-width: 860px;
      height: 100vh;
      max-height: 760px;
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      flex-direction: column;
      overflow: hidden;
    }

    /* ì±„íŒ… í—¤ë” */
    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
    }

    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chat-header-left h2 {
      font-size: 17px;
      font-weight: 700;
      color: var(--text);
    }

    .model-badge {
      font-size: 11px;
      font-weight: 600;
      background: #eef0ff;
      color: var(--primary);
      padding: 3px 8px;
      border-radius: 20px;
    }

    .chat-header-right {
      display: flex;
      gap: 8px;
    }

    .btn-sm {
      padding: 6px 14px;
      border: 1.5px solid var(--border);
      border-radius: 6px;
      background: transparent;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s;
    }

    .btn-sm:hover { background: var(--bg); color: var(--text); }

    .btn-sm.danger { color: var(--danger); border-color: #f5c6c3; }
    .btn-sm.danger:hover { background: #fdecea; }

    /* ë©”ì‹œì§€ ëª©ë¡ */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      scroll-behavior: smooth;
    }

    .messages::-webkit-scrollbar { width: 6px; }
    .messages::-webkit-scrollbar-track { background: transparent; }
    .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* ê°œë³„ ë©”ì‹œì§€ */
    .message {
      display: flex;
      gap: 10px;
      max-width: 80%;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message.agent {
      align-self: flex-start;
    }

    /* ì•„ë°”íƒ€ */
    .avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .message.user  .avatar { background: var(--primary);  }
    .message.agent .avatar { background: #eef0ff; }

    /* ë§í’ì„  */
    .bubble {
      padding: 11px 15px;
      border-radius: 16px;
      font-size: 14.5px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .message.user  .bubble {
      background: var(--user-bubble);
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    .message.agent .bubble {
      background: var(--agent-bubble);
      color: var(--text);
      border-bottom-left-radius: 4px;
      border: 1px solid var(--border);
    }

    /* ë¡œë”© ì  ì• ë‹ˆë©”ì´ì…˜ */
    .typing {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 14px 16px;
    }

    .typing span {
      width: 7px;
      height: 7px;
      background: var(--text-muted);
      border-radius: 50%;
      animation: bounce 1.2s infinite;
    }

    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30%           { transform: translateY(-6px); }
    }

    /* ì‹œìŠ¤í…œ ë©”ì‹œì§€ */
    .system-message {
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
      padding: 4px 12px;
      background: var(--bg);
      border-radius: 20px;
      align-self: center;
    }

    /* ì…ë ¥ ì˜ì—­ */
    .input-area {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      align-items: flex-end;
      background: var(--surface);
      flex-shrink: 0;
    }

    #message-input {
      flex: 1;
      padding: 11px 16px;
      border: 1.5px solid var(--border);
      border-radius: 24px;
      font-size: 14.5px;
      color: var(--text);
      outline: none;
      resize: none;
      line-height: 1.5;
      max-height: 120px;
      overflow-y: auto;
      transition: border-color 0.2s;
      font-family: inherit;
    }

    #message-input:focus { border-color: var(--primary); }

    #send-btn {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.2s, opacity 0.2s;
    }

    #send-btn:hover   { background: var(--primary-dark); }
    #send-btn:active  { opacity: 0.8; }
    #send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë¡œê·¸ì¸ í™”ë©´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">
      <div style="font-size:42px">ğŸ</div>
      <h1>Hive AI Agent</h1>
      <p>ìì—°ì–´ë¡œ Hive í…Œì´ë¸”ì„ ê´€ë¦¬í•˜ì„¸ìš”</p>
    </div>

    <div class="form-group">
      <label>Username</label>
      <input type="text" id="username" placeholder="ì‚¬ìš©ìëª… ì…ë ¥" autocomplete="username" />
    </div>

    <div class="form-group">
      <label>Password</label>
      <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" autocomplete="current-password" />
    </div>

    <button class="btn btn-primary" id="login-btn" onclick="login()">ë¡œê·¸ì¸</button>

    <div id="login-error"></div>
  </div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì±„íŒ… í™”ë©´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="chat-screen">
  <div class="chat-header">
    <div class="chat-header-left">
      <span style="font-size:22px">ğŸ</span>
      <h2>Hive AI Agent</h2>
      <span class="model-badge">Qwen Â· Ollama</span>
    </div>
    <div class="chat-header-right">
      <button class="btn-sm" onclick="resetChat()">ëŒ€í™” ì´ˆê¸°í™”</button>
      <button class="btn-sm danger" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>

  <div class="messages" id="messages"></div>

  <div class="input-area">
    <textarea
      id="message-input"
      rows="1"
      placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦ (Enter: ì „ì†¡, Shift+Enter: ì¤„ë°”ê¿ˆ)"
      onkeydown="handleKey(event)"
      oninput="autoResize(this)"
    ></textarea>
    <button id="send-btn" onclick="sendMessage()" title="ì „ì†¡">&#9658;</button>
  </div>
</div>

<script>
  // â”€â”€ ì „ì—­ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let sessionId = null;  // ë¡œê·¸ì¸ í›„ ì„œë²„ë¡œë¶€í„° ë°œê¸‰ë°›ì€ ì„¸ì…˜ ID

  // â”€â”€ ë¡œê·¸ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const errBox   = document.getElementById('login-error');
    const btn      = document.getElementById('login-btn');

    if (!username || !password) {
      showLoginError('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    btn.disabled    = true;
    btn.textContent = 'ë¡œê·¸ì¸ ì¤‘â€¦';
    errBox.style.display = 'none';

    try {
      const res  = await fetch('/api/login', {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify({ username, password }),
      });
      const data = await res.json();

      if (!res.ok) {
        // ì„œë²„ê°€ ë°˜í™˜í•œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        showLoginError(data.detail || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      // ë¡œê·¸ì¸ ì„±ê³µ â†’ ì„¸ì…˜ ID ì €ì¥ í›„ ì±„íŒ… í™”ë©´ìœ¼ë¡œ ì „í™˜
      sessionId = data.session_id;
      switchToChat();

    } catch (e) {
      showLoginError('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    } finally {
      btn.disabled    = false;
      btn.textContent = 'ë¡œê·¸ì¸';
    }
  }

  function showLoginError(msg) {
    const errBox = document.getElementById('login-error');
    errBox.textContent    = msg;
    errBox.style.display  = 'block';
  }

  // â”€â”€ í™”ë©´ ì „í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function switchToChat() {
    document.getElementById('login-screen').style.display = 'none';
    const chatScreen = document.getElementById('chat-screen');
    chatScreen.style.display = 'flex';
    // í™˜ì˜ ë©”ì‹œì§€ ì¶”ê°€
    addSystemMessage('ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”!');
    document.getElementById('message-input').focus();
  }

  function switchToLogin() {
    document.getElementById('chat-screen').style.display  = 'none';
    document.getElementById('login-screen').style.display = 'block';
    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    document.getElementById('password').value = '';
    document.getElementById('login-error').style.display = 'none';
    document.getElementById('messages').innerHTML = '';
    sessionId = null;
  }

  // â”€â”€ ë©”ì‹œì§€ ì „ì†¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function sendMessage() {
    const input   = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const message = input.value.trim();

    if (!message || !sessionId) return;

    // ì‚¬ìš©ì ë§í’ì„  ì¶”ê°€ í›„ ì…ë ¥ì°½ ì´ˆê¸°í™”
    addMessage('user', message);
    input.value = '';
    autoResize(input);

    // ì „ì†¡ ë²„íŠ¼ ë¹„í™œì„±í™” + ë¡œë”© í‘œì‹œ
    sendBtn.disabled = true;
    const typingEl = addTypingIndicator();

    try {
      const res  = await fetch('/api/chat', {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify({ session_id: sessionId, message }),
      });
      const data = await res.json();

      typingEl.remove();

      if (!res.ok) {
        // 401ì´ë©´ ì„¸ì…˜ ë§Œë£Œë¡œ ê°„ì£¼í•˜ê³  ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
        if (res.status === 401) {
          addSystemMessage('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
          setTimeout(switchToLogin, 1500);
          return;
        }
        addMessage('agent', `ì˜¤ë¥˜: ${data.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}`);
        return;
      }

      addMessage('agent', data.response);

    } catch (e) {
      typingEl.remove();
      addMessage('agent', 'ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      sendBtn.disabled = false;
      input.focus();
    }
  }

  // â”€â”€ ëŒ€í™” ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function resetChat() {
    if (!sessionId) return;

    try {
      await fetch('/api/reset', {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify({ session_id: sessionId }),
      });
    } catch (_) { /* ë¬´ì‹œ */ }

    // í™”ë©´ì˜ ë©”ì‹œì§€ ëª©ë¡ ì´ˆê¸°í™”
    document.getElementById('messages').innerHTML = '';
    addSystemMessage('ëŒ€í™” ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
  }

  // â”€â”€ ë¡œê·¸ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function logout() {
    if (sessionId) {
      try {
        await fetch('/api/logout', {
          method:  'POST',
          headers: { 'Content-Type': 'application/json' },
          body:    JSON.stringify({ session_id: sessionId }),
        });
      } catch (_) { /* ë¬´ì‹œ */ }
    }
    switchToLogin();
  }

  // â”€â”€ UI í—¬í¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /** ì‚¬ìš©ì ë˜ëŠ” Agent ë§í’ì„ ì„ ë©”ì‹œì§€ ëª©ë¡ì— ì¶”ê°€í•œë‹¤. */
  function addMessage(role, text) {
    const container = document.getElementById('messages');

    const wrapper = document.createElement('div');
    wrapper.className = `message ${role}`;

    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.textContent = role === 'user' ? 'ğŸ‘¤' : 'ğŸ';

    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;  // XSS ë°©ì§€ë¥¼ ìœ„í•´ textContent ì‚¬ìš©

    wrapper.appendChild(avatar);
    wrapper.appendChild(bubble);
    container.appendChild(wrapper);
    scrollToBottom();
  }

  /** ì‹œìŠ¤í…œ ì•ˆë‚´ ë©”ì‹œì§€(ê°€ìš´ë° ì •ë ¬)ë¥¼ ì¶”ê°€í•œë‹¤. */
  function addSystemMessage(text) {
    const container = document.getElementById('messages');
    const el = document.createElement('div');
    el.className   = 'system-message';
    el.textContent = text;
    container.appendChild(el);
    scrollToBottom();
  }

  /** Agent ì‘ë‹µ ëŒ€ê¸° ì¤‘ ë¡œë”© ì  ì• ë‹ˆë©”ì´ì…˜ì„ ì¶”ê°€í•˜ê³  í•´ë‹¹ ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ë°˜í™˜í•œë‹¤. */
  function addTypingIndicator() {
    const container = document.getElementById('messages');

    const wrapper = document.createElement('div');
    wrapper.className = 'message agent';

    const avatar = document.createElement('div');
    avatar.className   = 'avatar';
    avatar.textContent = 'ğŸ';

    const bubble = document.createElement('div');
    bubble.className = 'bubble';

    const typing = document.createElement('div');
    typing.className = 'typing';
    typing.innerHTML = '<span></span><span></span><span></span>';

    bubble.appendChild(typing);
    wrapper.appendChild(avatar);
    wrapper.appendChild(bubble);
    container.appendChild(wrapper);
    scrollToBottom();

    return wrapper;
  }

  /** ë©”ì‹œì§€ ëª©ë¡ì„ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•œë‹¤. */
  function scrollToBottom() {
    const container = document.getElementById('messages');
    container.scrollTop = container.scrollHeight;
  }

  /** textarea ë†’ì´ë¥¼ ë‚´ìš©ì— ë§ê²Œ ìë™ ì¡°ì ˆí•œë‹¤ (ìµœëŒ€ 120px). */
  function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  }

  /** Enter í‚¤ ì „ì†¡ / Shift+Enter ì¤„ë°”ê¿ˆ ì²˜ë¦¬. */
  function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  }

  // â”€â”€ ì´ˆê¸°í™”: Enter í‚¤ë¡œ ë¡œê·¸ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('password').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') login();
  });
  document.getElementById('username').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') document.getElementById('password').focus();
  });
</script>
</body>
</html>
